name: Jit Security Scan

on:
  workflow_dispatch:

jobs:
  setup-and-build:
    name: ðŸ› ï¸ Build Java Code
    runs-on: ubuntu-latest
    permissions: write-all

    outputs:
      build-status: ${{ steps.build.outcome }}

    env:
      JIT_CLIENT_ID: ${{ secrets.JIT_CLIENT_ID }}
      JIT_SECRET_KEY: ${{ secrets.JIT_SECRET_KEY }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ðŸ§° Set up Maven
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: 3.8.2

      - name: ðŸ—ï¸ Build Java Project
        id: build
        run: mvn clean install -DskipTests

  scan-container:
    name: ðŸ³ Jit Container Scan (Keycloak)
    runs-on: ubuntu-latest
    needs: setup-and-build

    env:
      JIT_CLIENT_ID: ${{ secrets.JIT_CLIENT_ID }}
      JIT_SECRET_KEY: ${{ secrets.JIT_SECRET_KEY }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Jit CLI
        run: |
          sudo apt-get update && sudo apt-get install -y curl git
          curl -L https://jit-cli.s3.us-east-1.amazonaws.com/jit-cli/latest/jit-cli-amd64-slim -o jit-cli
          chmod +x jit-cli
          ./jit-cli --help

      - name: ðŸ³ Pull Keycloak Image
        run: docker pull quay.io/keycloak/keycloak:24.0.2

      - name: ðŸ” Run Jit Container Scan
        run: |
          ./jit-cli container \
            --image quay.io/keycloak/keycloak:24.0.2 \
            --tracking-name keycloak-keycloak:24.0.2 \
            --fail-on-findings \
            --add-to-backlog

  scan-code:
    name: ðŸ“„ Jit Code/Dependency Scan
    runs-on: ubuntu-latest
    needs: setup-and-build

    env:
      JIT_CLIENT_ID: ${{ secrets.JIT_CLIENT_ID }}
      JIT_SECRET_KEY: ${{ secrets.JIT_SECRET_KEY }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Install Jit CLI
        run: |
          sudo apt-get update && sudo apt-get install -y curl git
          curl -L https://jit-cli.s3.us-east-1.amazonaws.com/jit-cli/latest/jit-cli-amd64-slim -o jit-cli
          chmod +x jit-cli
          ./jit-cli --help

      - name: ðŸ” Run Jit Code/Dependency Scan
        run: |
          ./jit-cli scan --path . --fail-on-findings --add-to-backlog

      - name: ðŸ“ Print Jit Scan Summary
        run: |
          echo "## ðŸ” Jit Scan Completed" >> $GITHUB_STEP_SUMMARY
          echo "Check logs for findings or failures."
