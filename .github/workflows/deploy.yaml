name: Combined Jit Scans

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  code-checks:
    name: ğŸ” Code & Dependency Scans
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # ğŸ“¦ SCA: Dependency Scan
      - name: ğŸ“¦ Scan Dependencies (SCA)
        uses: jitsecurity-controls/jit-github-action@v1
        with:
          security_control: scan-your-code-dependencies

      # ğŸ§  SAST: Static Analysis
      - name: ğŸ§  Static Code Scan (SAST)
        uses: jitsecurity-controls/jit-github-action@v1
        with:
          security_control: scan-your-code-for-vulnerabilities

      # ğŸ” Secrets Detection
      - name: ğŸ” Secrets Scan
        uses: jitsecurity-controls/jit-github-action@v1
        with:
          security_control: scan-for-hardcoded-secrets

      # â˜ï¸ IaC Scan
      - name: â˜ï¸ IaC Scan
        uses: jitsecurity-controls/jit-github-action@v1
        with:
          security_control: scan-your-infrastructure-as-code

  container-scan:
    name: ğŸ³ Container Image Scan
    runs-on: ubuntu-latest
    needs: code-checks

    env:
      JIT_CLIENT_ID: ${{ secrets.JIT_CLIENT_ID }}
      JIT_SECRET_KEY: ${{ secrets.JIT_SECRET_KEY }}

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install Jit CLI
        run: |
          sudo apt-get update && sudo apt-get install -y curl git
          curl -L https://jit-cli.s3.us-east-1.amazonaws.com/jit-cli/latest/jit-cli-amd64-slim -o jit-cli
          chmod +x jit-cli

      - name: ğŸ³ Pull Keycloak Image
        run: docker pull quay.io/keycloak/keycloak:24.0.2

      - name: ğŸ” Run Jit Container Scan
        run: |
          ./jit-cli container \
            --image quay.io/keycloak/keycloak:24.0.2 \
            --tracking-name keycloak-keycloak:24.0.2 \
            --fail-on-findings \
            --add-to-backlog
